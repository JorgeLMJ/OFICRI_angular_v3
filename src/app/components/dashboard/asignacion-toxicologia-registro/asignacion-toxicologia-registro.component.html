<div class="container-fluid p-0 animate-in fade-in duration-700" 
     style="height: calc(100vh - 65px); overflow: hidden; background-color: #f8fafc;">
  
  <div class="row g-0 h-100">
    
    <aside class="col-lg-4 col-md-5 bg-white border-end d-flex flex-column shadow-sm h-100" style="z-index: 10;">
      <div class="p-4 border-bottom bg-white d-flex justify-content-between align-items-center flex-shrink-0">
        <div>
          <h5 class="mb-0 font-black text-primary text-uppercase tracking-tighter">
            <i class="bi bi-beaker-fill me-2"></i>
            {{ editMode ? 'Actualizar' : 'Nueva' }} Asignación
          </h5>
          <p class="text-slate-400 small mb-0 font-medium tracking-tight">Peritaje Toxicológico</p>
        </div>
        <button (click)="cancelar()" class="btn-close shadow-none opacity-50"></button>
      </div>

      <div class="p-4 overflow-y-auto custom-scrollbar flex-grow-1 bg-slate-50/30">
        <form [formGroup]="asignacionForm" (ngSubmit)="onSubmit()" novalidate>
          <div class="card border-0 shadow-sm rounded-4 p-4 mb-4">
            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 d-block">Referencias del Caso</label>
            <div class="mb-4">
              <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2 d-block">Área de Laboratorio</label>
              <input type="text" class="form-control bg-slate-100 border-0 py-2.5 rounded-xl font-black text-slate-600 shadow-none" formControlName="area" readonly>
            </div>
            <div class="mb-2">
              <label class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2 d-block">Expediente Base</label>
              <div class="input-group overflow-hidden rounded-xl border border-slate-200 shadow-sm focus-within:ring-2 focus-within:ring-primary/20 transition-all">
                <input type="text" class="form-control border-0 py-2.5 font-bold text-primary shadow-none bg-white" [value]="documentoSeleccionadoInfo" placeholder="Seleccione expediente..." readonly>
                <button type="button" class="btn btn-primary px-3 border-0 active:scale-95" (click)="openDocumentoModal()" [disabled]="!puedeSeleccionarEntidades()">
                  <i class="bi bi-search"></i>
                </button>
              </div>
            </div>
          </div>

          <div class="card border-0 shadow-sm rounded-4 p-4 mb-4">
            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 d-block">Especialista Asignado</label>
            <div class="input-group overflow-hidden rounded-xl border border-slate-200 shadow-sm focus-within:ring-2 focus-within:ring-primary/20 transition-all">
              <span class="input-group-text bg-slate-50 border-0 ps-3"><i class="bi bi-person-badge text-primary"></i></span>
              <input type="text" class="form-control border-0 py-2.5 font-bold text-slate-700 shadow-none bg-white" [value]="empleadoSeleccionadoNombre" placeholder="Asignar Químico..." readonly>
              <button type="button" class="btn btn-primary px-3 border-0 active:scale-95" (click)="openEmpleadoModal()" [disabled]="!puedeSeleccionarEntidades()">
                <i class="bi bi-person-plus-fill"></i>
              </button>
            </div>
          </div>

          <div class="card border-0 shadow-sm rounded-4 p-4 mb-4">
            <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 d-block">Estado de la Muestra</label>
            <div class="btn-group w-100 rounded-xl overflow-hidden border border-slate-200 shadow-sm" role="group">
              <input type="radio" class="btn-check" formControlName="estado" value="EN_PROCESO" id="est-proc">
              <label class="btn btn-outline-warning border-0 font-black text-[10px] py-2.5 uppercase tracking-widest" for="est-proc">Proceso</label>
              <input type="radio" class="btn-check" formControlName="estado" value="COMPLETADO" id="est-comp" [disabled]="!puedeCompletar">
              <label class="btn btn-outline-success border-0 font-black text-[10px] py-2.5 uppercase tracking-widest" for="est-comp" [class.disabled]="!puedeCompletar">Completar</label>
            </div>
          </div>

          <div class="d-grid gap-3 pt-2 pb-5">
            <button type="submit" class="btn btn-primary py-3 rounded-2xl font-black text-xs uppercase tracking-widest shadow-xl shadow-primary/20 transition-all hover:-translate-y-0.5 active:scale-95" [disabled]="asignacionForm.invalid">
              <i class="bi bi-cloud-arrow-up-fill me-2 fs-6"></i> {{ editMode ? 'Actualizar' : 'Guardar' }} Pericia
            </button>
            <button type="button" class="btn btn-link text-slate-400 font-bold text-decoration-none text-[11px] uppercase tracking-widest" (click)="cancelar()">
              Descartar cambios
            </button>
          </div>
        </form>
      </div>
    </aside>

    <main class="col-lg-8 col-md-7 h-100 bg-slate-100/50 d-flex flex-column">
      <div class="px-4 px-lg-5 pb-5 py-0 overflow-y-auto h-100 custom-scrollbar">
        
        <div class="d-flex align-items-center border-bottom bg-slate-100 sticky-top shadow-sm" 
             style="z-index: 20; height: 75px; margin: 0 -3rem; padding: 0 3rem;">
          
          <div class="bg-white rounded-2xl text-primary border border-slate-200 me-4 d-flex align-items-center justify-content-center shadow-sm" 
               style="width: 48px; height: 48px;">
            <i class="bi bi-droplet-half fs-4"></i>
          </div>
          <div class="lh-sm">
            <h5 class="text-primary font-black uppercase tracking-tight mb-1" style="font-size: 18px;">Análisis de Sustancias</h5>
            <p class="text-slate-500 mb-0 font-bold" style="font-size: 13px;">Configuración técnica de reactivos químicos</p>
          </div>
        </div>

        <div class="mt-4"></div>

        <div class="row g-3" [formGroup]="$any(asignacionForm.get('resultados'))">
          <div class="col-12 col-xl-6" *ngFor="let drug of ['marihuana', 'cocaina', 'benzodiacepinas', 'barbituricos', 'carbamatos', 'estricnina', 'cumarinas', 'organofosforados', 'misoprostol', 'piretrinas']">
            <div class="card border-0 shadow-sm rounded-4 p-3 bg-white transition-all hover:shadow-md group border-start border-[5px] border-transparent"
                 [ngClass]="{
                   'border-rose-500': asignacionForm.get('resultados.' + drug)?.value === 'Positivo',
                   'border-emerald-500': asignacionForm.get('resultados.' + drug)?.value === 'Negativo'
                 }">
              
              <div class="d-flex justify-content-between align-items-center mb-2">
                <label class="font-black text-slate-700 text-xs uppercase tracking-tighter">{{ drug }}</label>
                <div class="badge bg-slate-50 text-slate-400 font-black text-[8px] uppercase tracking-widest px-2 py-1 rounded">Muestra A-1</div>
              </div>
              
              <div class="btn-group w-100 gap-2" role="group">
                <button type="button" class="btn py-2 rounded-xl font-black text-[9px] uppercase border-2 transition-all"
                        [ngClass]="asignacionForm.get('resultados.' + drug)?.value === 'Positivo' ? 'bg-rose-500 border-rose-500 text-white shadow-lg shadow-rose-100' : 'bg-white border-slate-100 text-slate-400'"
                        (click)="toggleResultado(drug, 'Positivo')">Positivo</button>
                <button type="button" class="btn py-2 rounded-xl font-black text-[9px] uppercase border-2 transition-all"
                        [ngClass]="asignacionForm.get('resultados.' + drug)?.value === 'Negativo' ? 'bg-emerald-500 border-emerald-500 text-white shadow-lg shadow-emerald-100' : 'bg-white border-slate-100 text-slate-400'"
                        (click)="toggleResultado(drug, 'Negativo')">Negativo</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>